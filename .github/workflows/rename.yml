name: AI-Powered Code Renaming 

on:
  push:
    branches:
      - main

jobs:
  rename_files:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required to commit output files

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Load Cached Filenames
        id: load_cache
        run: |
          CACHE_FILE=".renamed_files.json"
          [[ -f "$CACHE_FILE" ]] || echo "{}" > "$CACHE_FILE"
          echo "CACHE_FILE=$CACHE_FILE" >> $GITHUB_ENV

      - name: Cache Renamed Files
        uses: actions/cache@v3
        with:
          path: .renamed_files.json
          key: renamed-files-cache-${{ github.sha }}
          restore-keys: renamed-files-cache-

      - name: Find Modified or New Python Files
        id: list_files
        run: |
          files=$(git diff --name-only HEAD~1 HEAD -- "OTHER/*.py" 2>/dev/null || git ls-files "OTHER/*.py")
          files=$(echo "$files" | jq -R -s -c 'split("\n") | map(select(. != ""))')
          echo "files=$files" >> $GITHUB_ENV

      - name: Generate AI-Based Filenames and Handle Caching
        id: rename_files
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          declare -A filenames
          CACHE_FILE="$CACHE_FILE"
          TEMP_CACHE=".temp_cache.json"

          cp "$CACHE_FILE" "$TEMP_CACHE" || echo "{}" > "$TEMP_CACHE"

          for file in $(echo $files | jq -r '.[]'); do
            [[ ! -f "$file" ]] && continue

            code=$(<"$file")
            hash=$(echo -n "$code" | sha256sum | cut -d' ' -f1)

            new_name=$(jq -r --arg hash "$hash" '.[$hash] // empty' "$TEMP_CACHE")

            if [[ -z "$new_name" ]]; then
              response=$(curl -s https://api.groq.com/openai/v1/chat/completions \
                -H "Authorization: Bearer $OPENAI_API_KEY" \
                -H "Content-Type: application/json" \
                -d '{
                  "model": "llama-3.3-70b-specdec",
                  "messages": [{"role": "user", "content": "Analyze this Python script and suggest a meaningful filename in snake_case format. Do not include any explanation:\n\n```\n'"$code"'\n```"}]
                }')

              echo "AI Response for $file: $response"  # Log raw response

              new_name=$(echo "$response" | jq -r '.choices[0].message.content' | tr -d '[:space:]')
              new_name=$(echo "$new_name" | tr ' ' '_')
              new_name="OTHER/${new_name}.py"

              if [[ -z "$new_name" || "$new_name" == "OTHER/.py" ]]; then
                echo "AI filename generation failed for $file. Skipping..."
                continue
              fi

              base_name="${new_name%.py}"
              count=1
              while [[ -e "$new_name" || ${filenames[$new_name]} ]]; do
                new_name="${base_name}_${count}.py"
                ((count++))
              done

              filenames["$new_name"]=1
              jq --arg hash "$hash" --arg name "$new_name" '. + {($hash): $name}' "$TEMP_CACHE" > "$TEMP_CACHE.tmp" && mv "$TEMP_CACHE.tmp" "$TEMP_CACHE"
            fi

            echo "Renaming: $file -> $new_name"
            mv "$file" "$new_name"
          done

          mv "$TEMP_CACHE" "$CACHE_FILE"

      - name: Commit and Push Changes
        run: |
          git config --local user.name "github-actions"
          git config --local user.email "github-actions@github.com"

          git add .
          git diff --cached --quiet || (git commit -m 'Automated AI-based renaming' && git pull --rebase && git push origin main)
